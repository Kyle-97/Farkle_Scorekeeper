<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Farkle Scorekeeper</title>

    <!-- Custom Icons -->
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

<link rel="manifest" href="manifest.json?v=99">
    
    
    
    <!-- App Mode (Hides browser bar when saved to home screen) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black"> 
    <meta name="mobile-web-app-capable" content="yes">
    
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom scrollbar for history */
        .history-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .history-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .history-scroll::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 2px;
        }
        
        button {
            touch-action: manipulation;
        }
        
        @keyframes pulse-red {
            0%, 100% { background-color: #ef4444; } /* red-500 */
            50% { background-color: #b91c1c; } /* red-700 */
        }
        .animate-pulse-red {
            animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden select-none font-sans">

<div id="root" class="h-full w-full"></div>

<script type="text/babel">

    const { useState, useEffect, useRef } = React;

    // --- Components ---

    function App() {
        const [gameState, setGameState] = useState('SETUP'); // SETUP, PLAYING, FINISHED, HISTORY
        const [players, setPlayers] = useState([]);
        const [settings, setSettings] = useState({
            winningScore: 10000,
            penaltyThreeFarkles: true,
            penaltyAmount: 1000
        });
        
        // Load history from local storage
        const [gameHistory, setGameHistory] = useState(() => {
            const saved = localStorage.getItem('farkle_history');
            return saved ? JSON.parse(saved) : [];
        });

        // Save history whenever it changes
        useEffect(() => {
            localStorage.setItem('farkle_history', JSON.stringify(gameHistory));
        }, [gameHistory]);

        const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
        const [currentInput, setCurrentInput] = useState('');
        const [winner, setWinner] = useState(null);
        
        // New State for "Last Round" logic
        const [lastRoundTriggerId, setLastRoundTriggerId] = useState(null);

        // -- Setup Logic --
        const addPlayer = (name) => {
            if (!name.trim()) return;
            setPlayers([...players, {
                id: Date.now(),
                name: name.trim(),
                score: 0,
                history: [], 
                consecutiveFarkles: 0,
                rank: 1
            }]);
        };

        const removePlayer = (id) => {
            setPlayers(players.filter(p => p.id !== id));
        };

        const startGame = () => {
            if (players.length < 1) return;
            setGameState('PLAYING');
            setCurrentPlayerIndex(0);
            setLastRoundTriggerId(null);
        };

        // -- Game Logic --
        const handleScoreInput = (value) => {
            if (currentInput.length > 5) return; 
            setCurrentInput(prev => prev + value);
        };

        const handleBackspace = () => {
            setCurrentInput(prev => prev.slice(0, -1));
        };

        const handleClear = () => {
            setCurrentInput('');
        };

        const submitTurn = (isFarkle) => {
            const points = isFarkle ? 0 : (parseInt(currentInput) || 0);
            const actualIsFarkle = isFarkle || points === 0;

            const updatedPlayers = [...players];
            const player = updatedPlayers[currentPlayerIndex];

            // Handle Consecutive Farkles
            if (actualIsFarkle) {
                player.consecutiveFarkles += 1;
                if (settings.penaltyThreeFarkles && player.consecutiveFarkles >= 3) {
                    player.score -= settings.penaltyAmount;
                    player.history.push({ value: 0, type: 'farkle', note: 'Farkle' });
                    player.history.push({ value: -settings.penaltyAmount, type: 'penalty', note: '3x Farkle Penalty' });
                    player.consecutiveFarkles = 0; 
                } else {
                     player.history.push({ value: 0, type: 'farkle', note: `Farkle (${player.consecutiveFarkles})` });
                }
            } else {
                player.score += points;
                player.consecutiveFarkles = 0;
                player.history.push({ value: points, type: 'score' });
            }

            // Update Ranks immediately for visuals
            const tempSorted = [...updatedPlayers].sort((a, b) => b.score - a.score);
            updatedPlayers.forEach(p => {
                const rankIndex = tempSorted.findIndex(s => s.id === p.id);
                p.rank = rankIndex + 1;
            });

            // 1. Check if Last Round needs to be triggered
            if (!lastRoundTriggerId && player.score >= settings.winningScore) {
                setLastRoundTriggerId(player.id);
                // If single player mode, end immediately
                if (players.length === 1) {
                    finishGame(updatedPlayers);
                    return;
                }
            }

            setPlayers(updatedPlayers);
            setCurrentInput('');

            // 2. Check if Game Over (Turn has returned to the trigger player)
            const nextIndex = (currentPlayerIndex + 1) % players.length;
            const nextPlayerId = players[nextIndex].id;

            if (lastRoundTriggerId && nextPlayerId === lastRoundTriggerId) {
                finishGame(updatedPlayers);
            } else {
                nextTurn();
            }
        };

        const finishGame = (finalPlayers) => {
            // Find the actual winner (highest score)
            const trueWinner = finalPlayers.reduce((prev, current) => (prev.score > current.score) ? prev : current);
            
            setWinner(trueWinner);
            setGameState('FINISHED');
            
            // Save to history
            const newRecord = {
                id: Date.now(),
                date: new Date().toISOString(),
                winnerName: trueWinner.name,
                winnerScore: trueWinner.score,
                players: finalPlayers.map(p => ({ name: p.name, score: p.score, rank: p.rank }))
            };
            setGameHistory(prev => [newRecord, ...prev]);
        };

        const nextTurn = () => {
            setCurrentPlayerIndex((prev) => (prev + 1) % players.length);
        };

        const resetGame = () => {
            setGameState('SETUP');
            setWinner(null);
            setLastRoundTriggerId(null);
            setPlayers(players.map(p => ({ ...p, score: 0, history: [], consecutiveFarkles: 0, rank: 1 })));
        };

        const continueGame = () => {
            setGameState('PLAYING');
            setWinner(null);
            setLastRoundTriggerId(null);
            nextTurn();
        };

        // --- History Management ---
        const clearHistory = () => {
            setGameHistory([]);
        };

        const deleteHistoryItem = (id) => {
            setGameHistory(prev => prev.filter(g => g.id !== id));
        };

        return (
            <div className="flex flex-col h-full max-w-md mx-auto bg-white shadow-xl relative">
                
                {/* Header */}
                <header className="bg-red-700 text-white p-4 shadow-md flex justify-between items-center z-10">
                    <h1 className="text-xl font-bold flex items-center gap-2">
                        <i className="fa-solid fa-dice"></i> Farkle Keeper
                    </h1>
                    {gameState === 'PLAYING' && (
                        <button onClick={() => setGameState('SETUP')} className="text-xs bg-red-800 px-2 py-1 rounded">
                            Menu
                        </button>
                    )}
                </header>

                {/* Content Area */}
                <main className="flex-1 overflow-hidden flex flex-col relative">
                    
                    {gameState === 'SETUP' && (
                        <SetupScreen 
                            players={players} 
                            addPlayer={addPlayer} 
                            removePlayer={removePlayer} 
                            startGame={startGame}
                            settings={settings}
                            setSettings={setSettings}
                            goToHistory={() => setGameState('HISTORY')}
                        />
                    )}

                    {gameState === 'HISTORY' && (
                        <HistoryScreen 
                            history={gameHistory} 
                            onBack={() => setGameState('SETUP')}
                            onClear={clearHistory}
                            onDeleteSingle={deleteHistoryItem}
                        />
                    )}

                    {gameState === 'PLAYING' && (
                        <GameScreen 
                            players={players} 
                            currentPlayerIndex={currentPlayerIndex}
                            currentInput={currentInput}
                            handleScoreInput={handleScoreInput}
                            handleBackspace={handleBackspace}
                            handleClear={handleClear}
                            submitTurn={submitTurn}
                            winningScore={settings.winningScore}
                            lastRoundTriggerId={lastRoundTriggerId}
                        />
                    )}

                    {gameState === 'FINISHED' && winner && (
                         <WinnerScreen 
                            winner={winner} 
                            resetGame={resetGame}
                            continueGame={continueGame}
                        />
                    )}
                    
                </main>
            </div>
        );
    }

    // --- Sub-Components ---

    function SetupScreen({ players, addPlayer, removePlayer, startGame, settings, setSettings, goToHistory }) {
        const [newName, setNewName] = useState('');

        const handleSubmit = (e) => {
            e.preventDefault();
            addPlayer(newName);
            setNewName('');
        };

        return (
            <div className="p-6 flex flex-col h-full overflow-y-auto">
                <div className="flex justify-end mb-4">
                    <button onClick={goToHistory} className="text-slate-500 hover:text-slate-800 text-sm font-bold flex items-center gap-1">
                        <i className="fa-solid fa-clock-rotate-left"></i> History
                    </button>
                </div>

                <div className="mb-6">
                    <h2 className="text-lg font-semibold mb-2 text-slate-700">Add Players</h2>
                    <form onSubmit={handleSubmit} className="flex gap-2">
                        <input 
                            type="text" 
                            value={newName}
                            onChange={(e) => setNewName(e.target.value)}
                            placeholder="Player Name"
                            className="flex-1 border border-slate-300 rounded px-4 py-3 text-lg focus:outline-none focus:border-red-500"
                            autoFocus
                        />
                        <button type="submit" className="bg-slate-800 text-white px-6 rounded font-bold hover:bg-slate-700">
                            <i className="fa-solid fa-plus"></i>
                        </button>
                    </form>
                </div>

                <div className="flex-1 overflow-y-auto mb-6">
                    {players.length === 0 ? (
                        <div className="text-slate-400 text-center mt-10 italic">
                            No players added yet.
                        </div>
                    ) : (
                        <ul className="space-y-2">
                            {players.map((p, idx) => (
                                <li key={p.id} className="flex justify-between items-center bg-slate-50 p-3 rounded border border-slate-200 animate-fadeIn">
                                    <span className="font-medium text-lg text-slate-700">
                                        <span className="text-slate-400 mr-2 text-sm">{idx + 1}.</span>
                                        {p.name}
                                    </span>
                                    <button onClick={() => removePlayer(p.id)} className="text-red-400 hover:text-red-600 px-3 py-1">
                                        <i className="fa-solid fa-trash"></i>
                                    </button>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>

                <div className="mb-6 bg-slate-50 p-4 rounded border border-slate-200 text-sm">
                    <h3 className="font-bold text-slate-700 mb-2">Game Settings</h3>
                    <div className="flex justify-between items-center mb-2">
                        <label>Winning Score</label>
                        <select 
                            value={settings.winningScore} 
                            onChange={(e) => setSettings({...settings, winningScore: Number(e.target.value)})}
                            className="border rounded p-1 bg-white"
                        >
                            <option value="5000">5,000</option>
                            <option value="10000">10,000</option>
                            <option value="20000">20,000</option>
                        </select>
                    </div>
                    <div className="flex justify-between items-center">
                        <label className="flex items-center gap-2">
                            <span>Penalty for 3x Farkles</span>
                            <span className="text-xs text-red-500 font-bold">(-1000)</span>
                        </label>
                        <input 
                            type="checkbox" 
                            checked={settings.penaltyThreeFarkles} 
                            onChange={(e) => setSettings({...settings, penaltyThreeFarkles: e.target.checked})}
                            className="w-5 h-5 accent-red-600"
                        />
                    </div>
                </div>

                <button 
                    onClick={startGame}
                    disabled={players.length < 1}
                    className={`w-full py-4 rounded-lg font-bold text-xl shadow-lg transition-all ${
                        players.length < 1 
                        ? 'bg-slate-300 text-slate-500 cursor-not-allowed' 
                        : 'bg-red-600 text-white hover:bg-red-700 active:scale-95'
                    }`}
                >
                    Start Game
                </button>
            </div>
        );
    }

    function HistoryScreen({ history, onBack, onClear, onDeleteSingle }) {
        const [showConfirm, setShowConfirm] = useState(false);

        return (
            <div className="flex flex-col h-full bg-slate-50 relative">
                <div className="p-4 bg-white border-b border-slate-200 flex justify-between items-center shadow-sm">
                    <button onClick={onBack} className="text-slate-600 hover:text-red-600 font-bold">
                        <i className="fa-solid fa-arrow-left"></i> Back
                    </button>
                    <h2 className="font-bold text-slate-800">Game History</h2>
                    <button 
                        onClick={() => setShowConfirm(true)} 
                        disabled={history.length === 0}
                        className="text-red-400 hover:text-red-600 disabled:opacity-30 disabled:cursor-not-allowed text-sm font-semibold border border-red-200 rounded px-2 py-1 bg-red-50"
                    >
                        Clear All
                    </button>
                </div>
                
                {/* Custom Confirmation Modal */}
                {showConfirm && (
                    <div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg p-6 shadow-xl w-full max-w-xs animate-fadeIn">
                            <h3 className="font-bold text-lg mb-2 text-slate-800">Clear all history?</h3>
                            <p className="text-slate-500 mb-6 text-sm">This action cannot be undone.</p>
                            <div className="flex gap-3">
                                <button 
                                    onClick={() => setShowConfirm(false)} 
                                    className="flex-1 py-2 bg-slate-200 rounded font-bold text-slate-700 active:bg-slate-300"
                                >
                                    Cancel
                                </button>
                                <button 
                                    onClick={() => { onClear(); setShowConfirm(false); }} 
                                    className="flex-1 py-2 bg-red-600 rounded font-bold text-white active:bg-red-700"
                                >
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                <div className="flex-1 overflow-y-auto p-4 history-scroll">
                    {history.length === 0 ? (
                        <div className="text-center text-slate-400 mt-20">
                            <i className="fa-solid fa-ghost text-4xl mb-4 opacity-30"></i>
                            <p>No games played yet.</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {history.map(game => (
                                <div key={game.id} className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden group">
                                    <div className="bg-slate-100 p-3 flex justify-between items-center border-b border-slate-100">
                                        <div className="flex items-center gap-2">
                                            <div className="font-bold text-slate-700">
                                                <i className="fa-solid fa-trophy text-yellow-500 mr-2"></i>
                                                {game.winnerName}
                                            </div>
                                            <span className="text-xs text-slate-400 font-mono">
                                                ({game.winnerScore.toLocaleString()})
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <div className="text-xs text-slate-500">
                                                {new Date(game.date).toLocaleDateString()}
                                            </div>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onDeleteSingle(game.id); }}
                                                className="w-6 h-6 flex items-center justify-center rounded-full text-slate-400 hover:text-white hover:bg-red-500 transition-colors"
                                            >
                                                <i className="fa-solid fa-xmark text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div className="p-3">
                                        <div className="space-y-1">
                                            {game.players.sort((a,b) => b.score - a.score).map((p, idx) => (
                                                <div key={idx} className="flex justify-between text-sm">
                                                    <span className={p.name === game.winnerName ? 'font-bold text-slate-800' : 'text-slate-500'}>
                                                        {idx+1}. {p.name}
                                                    </span>
                                                    <span className="font-mono text-slate-600">{p.score.toLocaleString()}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );
    }

    function GameScreen({ players, currentPlayerIndex, currentInput, handleScoreInput, handleBackspace, handleClear, submitTurn, winningScore, lastRoundTriggerId }) {
        const currentPlayer = players[currentPlayerIndex];
        const scrollRef = useRef(null);

        // Calculate leading score
        const leadingScore = Math.max(...players.map(p => p.score));

        useEffect(() => {
            if (scrollRef.current) {
                scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }
        }, [currentPlayer]);

        return (
            <div className="flex flex-col h-full bg-slate-100">
                {/* Last Round Banner */}
                {lastRoundTriggerId && (
                    <div className="bg-yellow-400 text-yellow-900 text-center py-2 px-4 font-bold text-sm shadow animate-pulse">
                        <i className="fa-solid fa-triangle-exclamation mr-2"></i>
                        LAST ROUND! Beat {leadingScore.toLocaleString()} to win!
                    </div>
                )}

                <div className="flex-1 overflow-y-auto p-2 space-y-2 pb-32">
                    {players.map((p, idx) => {
                        const isCurrent = idx === currentPlayerIndex;
                        const isTrigger = p.id === lastRoundTriggerId;
                        const isWinning = p.score >= winningScore;
                        return (
                            <div 
                                key={p.id} 
                                className={`flex flex-col relative rounded-lg border transition-all duration-300 ${
                                    isCurrent 
                                    ? 'bg-white border-red-500 shadow-md transform scale-102 ring-2 ring-red-100' 
                                    : 'bg-white border-slate-200 opacity-90'
                                }`}
                            >
                                <div className="flex justify-between items-center p-3">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${isCurrent ? 'bg-red-600 text-white' : 'bg-slate-200 text-slate-500'}`}>
                                            {p.rank}
                                        </div>
                                        <div>
                                            <div className="font-bold text-lg leading-tight flex items-center gap-2">
                                                {p.name} 
                                                {isTrigger && <span className="text-xs bg-yellow-400 text-yellow-900 px-1 rounded">Finished</span>}
                                            </div>
                                            <div className="text-xs text-slate-400">
                                                {p.consecutiveFarkles > 0 && (
                                                    <span className="text-red-500 font-bold">
                                                        {p.consecutiveFarkles} Farkle{p.consecutiveFarkles > 1 ? 's' : ''} in a row
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-2xl font-mono font-bold text-slate-800">
                                        {p.score.toLocaleString()}
                                    </div>
                                </div>
                                {p.history.length > 0 && (
                                    <div className="px-3 pb-2 text-xs text-right text-slate-400 border-t border-slate-100 pt-1 flex justify-end gap-2">
                                        <span>Last: </span>
                                        {p.history.slice(-3).reverse().map((h, i) => (
                                            <span key={i} className={h.value === 0 ? 'text-red-400' : 'text-green-600'}>
                                                {h.value === 0 ? 'F' : h.value}
                                            </span>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>

                <div className="bg-white border-t border-slate-300 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
                    <div className="flex justify-between items-center px-4 py-2 border-b border-slate-100 bg-slate-50">
                        <div className="text-sm font-semibold text-slate-500">
                            {currentPlayer.name}'s Turn
                        </div>
                        <div className="text-3xl font-mono font-bold text-slate-800 h-10 min-w-[100px] text-right">
                            {currentInput || <span className="text-slate-300">0</span>}
                        </div>
                    </div>
                    <div className="grid grid-cols-4 gap-1 p-2 bg-slate-100">
                        {[1, 2, 3].map(n => <NumBtn key={n} num={n} onClick={handleScoreInput} />)}
                        <button onClick={() => submitTurn(true)} className="row-span-2 bg-red-600 active:bg-red-700 text-white rounded font-bold text-sm shadow flex flex-col items-center justify-center gap-1 transition-transform active:scale-95">
                            <i className="fa-solid fa-ban text-2xl"></i>
                            FARKLE
                        </button>
                        {[4, 5, 6].map(n => <NumBtn key={n} num={n} onClick={handleScoreInput} />)}
                        {[7, 8, 9].map(n => <NumBtn key={n} num={n} onClick={handleScoreInput} />)}
                        <button onClick={handleBackspace} className="bg-slate-300 active:bg-slate-400 text-slate-700 rounded shadow h-14 flex items-center justify-center text-lg">
                            <i className="fa-solid fa-delete-left"></i>
                        </button>
                        <button onClick={handleClear} className="bg-slate-300 active:bg-slate-400 text-slate-700 rounded shadow h-14 font-bold text-sm">C</button>
                        <NumBtn num={0} onClick={handleScoreInput} />
                        <button onClick={() => submitTurn(false)} className="col-span-2 bg-green-600 active:bg-green-700 text-white rounded shadow h-14 font-bold text-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                            ENTER <i className="fa-solid fa-check"></i>
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    function NumBtn({ num, onClick }) {
        return (
            <button 
                onClick={() => onClick(num.toString())}
                className="bg-white active:bg-slate-200 text-slate-800 rounded shadow h-14 font-bold text-2xl transition-colors"
            >
                {num}
            </button>
        );
    }

    function WinnerScreen({ winner, resetGame, continueGame }) {
        return (
            <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-6 backdrop-blur-sm animate-fadeIn">
                <div className="bg-white w-full max-w-sm rounded-2xl p-8 text-center shadow-2xl transform transition-all scale-100">
                    <div className="text-6xl text-yellow-500 mb-4 animate-bounce">
                        <i className="fa-solid fa-crown"></i>
                    </div>
                    <h2 className="text-3xl font-bold text-slate-800 mb-2">Winner!</h2>
                    <div className="text-2xl text-red-600 font-bold mb-6">{winner.name}</div>
                    <div className="text-slate-500 mb-8">
                        Score: <span className="font-mono font-bold text-slate-800">{winner.score.toLocaleString()}</span>
                    </div>
                    
                    <div className="space-y-3">
                        <button onClick={resetGame} className="w-full bg-red-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-red-700">
                            New Game
                        </button>
                        <button onClick={continueGame} className="w-full bg-transparent text-slate-400 py-3 rounded-lg font-bold hover:text-white">
                            Continue Playing
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>
